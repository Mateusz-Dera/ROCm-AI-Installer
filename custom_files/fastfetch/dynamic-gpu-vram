#!/bin/bash

# Run the get-gpu-vram command and capture output
output=$(get-gpu-vram)

# Exit if no output
if [ -z "$output" ]; then
    echo ""
    exit 0
fi

# Initialize JSON modules array
modules=""
gpu_counter=1

# Process each line of output
while IFS= read -r line; do
    # Split by the || delimiter to get name and info
    gpu_name=$(echo "$line" | cut -d'|' -f1)
    vram_info=$(echo "$line" | cut -d'|' -f3-)  # Allows for cases where || might appear in the vram_info
    
    # Create display text based on whether memory info is available
    if [[ "$vram_info" == "Memory info unavailable" ]]; then
        # Just show card name if memory unavailable
        display_text="$gpu_name"
    else
        # Show card name and memory info
        display_text="$gpu_name $vram_info"
    fi
    
    # Escape any quotes in the display text
    escaped_display_text=$(echo "$display_text" | sed 's/"/\\"/g')
    
    # Create the key in format GPU <number>:
    key="GPU ${gpu_counter}"
    
    # Create a JSON module for this GPU
    if [ -n "$modules" ]; then
        modules="${modules},"
    fi
    modules="${modules}{\"type\": \"command\", \"text\": \"echo '$escaped_display_text'\", \"key\": \"$key\"}"
    
    # Increment counter for next GPU
    gpu_counter=$((gpu_counter + 1))
done <<< "$output"

# Output the JSON
echo "$modules"
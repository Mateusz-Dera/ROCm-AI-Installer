#!/bin/bash

# Function to get all GPUs in lspci order with vendor info
get_all_gpus() {
    lspci | grep ' VGA ' | while read -r line; do
        bus_id=$(echo "$line" | awk '{print $1}')
        
        if echo "$line" | grep -qi "AMD"; then
            gpu_name=$(echo "$line" | sed 's/.*\[AMD\/ATI\] //; s/ \[.*\]//')
            echo "$bus_id|AMD|$gpu_name"
        elif echo "$line" | grep -qi "NVIDIA"; then
            gpu_name=$(echo "$line" | sed 's/.*NVIDIA Corporation //; s/ \[.*\]//')
            echo "$bus_id|NVIDIA|$gpu_name"
        elif echo "$line" | grep -qi "Intel"; then
            gpu_name=$(echo "$line" | sed 's/.*Intel Corporation //; s/ \[.*\]//')
            echo "$bus_id|Intel|$gpu_name"
        fi
    done
}

# Check for required tools
has_rocm_smi=false
has_nvidia_smi=false
has_intel_gpu_top=false

if command -v rocm-smi &> /dev/null; then
    has_rocm_smi=true
fi

if command -v nvidia-smi &> /dev/null; then
    has_nvidia_smi=true
fi

if command -v intel_gpu_top &> /dev/null; then
    has_intel_gpu_top=true
fi

# Get all GPUs in system order
gpu_data=$(get_all_gpus)

# Check if any GPUs are found
if [ -z "$gpu_data" ]; then
    exit 0
fi

# Initialize counters for each vendor
amd_index=0
nvidia_index=0
intel_index=0

# Process GPUs in system order
echo "$gpu_data" | while IFS='|' read -r bus_id vendor gpu_name; do
    case $vendor in
        "AMD")
            if $has_rocm_smi; then
                # Get GPU name and memory info using rocm-smi
                amd_gpu_name=$(rocm-smi --showproductname -d $amd_index 2>/dev/null | grep 'Card Series' | awk -F: '{print $NF}' | xargs)
                if [ -z "$amd_gpu_name" ]; then
                    amd_gpu_name="$gpu_name"
                fi
                
                used_mem_bytes=$(rocm-smi --showmeminfo vram -d $amd_index 2>/dev/null | grep 'Used Memory' | awk '{print $NF}')
                total_mem_bytes=$(rocm-smi --showmeminfo vram -d $amd_index 2>/dev/null | grep 'Total Memory' | awk '{print $NF}')
                
                if [ -n "$used_mem_bytes" ] && [ -n "$total_mem_bytes" ]; then
                    used_mem_mb=$(echo "$used_mem_bytes / 1048576" | bc 2>/dev/null || echo "0")
                    total_mem_mb=$(echo "$total_mem_bytes / 1048576" | bc 2>/dev/null || echo "0")
                    echo "$amd_gpu_name||$used_mem_mb/$total_mem_mb MB"
                else
                    echo "$amd_gpu_name||Memory info unavailable"
                fi
                amd_index=$((amd_index + 1))
            else
                echo "$gpu_name||Memory info unavailable"
            fi
            ;;
        "NVIDIA")
            if $has_nvidia_smi; then
                # Get GPU name and memory info using nvidia-smi
                nvidia_gpu_name=$(nvidia-smi --query-gpu=name --format=csv,noheader -i $nvidia_index 2>/dev/null)
                if [ -z "$nvidia_gpu_name" ]; then
                    nvidia_gpu_name="$gpu_name"
                fi
                
                mem_info=$(nvidia-smi --query-gpu=memory.used,memory.total --format=csv,noheader,nounits -i $nvidia_index 2>/dev/null)
                if [ -n "$mem_info" ]; then
                    used=$(echo "$mem_info" | awk -F ', ' '{print $1}')
                    total=$(echo "$mem_info" | awk -F ', ' '{print $2}')
                    echo "$nvidia_gpu_name||$used/$total MB"
                else
                    echo "$nvidia_gpu_name||Memory info unavailable"
                fi
                nvidia_index=$((nvidia_index + 1))
            else
                echo "$gpu_name||Memory info unavailable"
            fi
            ;;
        "Intel")
            # Intel GPU memory detection is complex
            intel_memory=""
            if $has_intel_gpu_top; then
                # Try to get memory info from /sys filesystem
                if [ -d "/sys/class/drm/card$intel_index" ]; then
                    if [ -r "/sys/class/drm/card$intel_index/device/mem_info_vram_total" ]; then
                        total_bytes=$(cat "/sys/class/drm/card$intel_index/device/mem_info_vram_total" 2>/dev/null)
                        used_bytes=$(cat "/sys/class/drm/card$intel_index/device/mem_info_vram_used" 2>/dev/null)
                        if [ -n "$total_bytes" ] && [ -n "$used_bytes" ]; then
                            total_mb=$(echo "$total_bytes / 1048576" | bc 2>/dev/null || echo "0")
                            used_mb=$(echo "$used_bytes / 1048576" | bc 2>/dev/null || echo "0")
                            intel_memory="${used_mb}/${total_mb} MB"
                        fi
                    fi
                fi
                intel_index=$((intel_index + 1))
            fi
            
            if [ -z "$intel_memory" ]; then
                intel_memory="Memory info unavailable"
            fi
            
            echo "$gpu_name||$intel_memory"
            ;;
    esac
done
#!/bin/bash

# Function to get AMD GPU names and count
get_amd_gpus() {
    lspci -nn | grep -i "VGA" | grep -i "AMD" | sed 's/.*\[AMD\/ATI\] //; s/ \[.*\]//'
}

# Function to count AMD GPUs
count_amd_gpus() {
    lspci | grep -i "VGA" | grep -i "AMD" | wc -l
}

# Function to count NVIDIA GPUs
count_nvidia_gpus() {
    if command -v nvidia-smi &> /dev/null; then
        nvidia-smi --query-gpu=count --format=csv,noheader
    else
        echo 0
    fi
}

# Check for required tools
has_rocm_smi=false
has_nvidia_smi=false

if command -v rocm-smi &> /dev/null; then
    has_rocm_smi=true
fi

if command -v nvidia-smi &> /dev/null; then
    has_nvidia_smi=true
fi

# Count GPUs
amd_count=$(count_amd_gpus)
nvidia_count=$(count_nvidia_gpus)

# Get GPU names
amd_names=()
if [ "$amd_count" -gt 0 ]; then
    while IFS= read -r line; do
        amd_names+=("$line")
    done < <(get_amd_gpus)
fi

nvidia_names=()
if [ "$nvidia_count" -gt 0 ] && $has_nvidia_smi; then
    while IFS= read -r line; do
        nvidia_names+=("$line")
    done < <(nvidia-smi --query-gpu=name --format=csv,noheader)
fi

# Check if any GPUs are found
if [ "$amd_count" -le 0 ] && [ "$nvidia_count" -le 0 ]; then
    exit 0
fi

# Process AMD GPUs if found
if [ "$amd_count" -gt 0 ]; then
    if $has_rocm_smi; then
        # Loop through each AMD GPU index
        for ((gpu=0; gpu<amd_count; gpu++)); do
            used_mem_bytes=$(rocm-smi --showmeminfo vram -d $gpu | grep 'Used Memory' | awk '{print $NF}')
            total_mem_bytes=$(rocm-smi --showmeminfo vram -d $gpu | grep 'Total Memory' | awk '{print $NF}')
            used_mem_mb=$(echo "$used_mem_bytes / 1048576" | bc)
            total_mem_mb=$(echo "$total_mem_bytes / 1048576" | bc)
            
            # Output format: GPU_NAME||VRAM_INFO
            # FIX: Use $gpu instead of 0 to get the correct GPU name
            gpu_name=$(rocm-smi --showproductname -d $gpu | grep 'Card Series' | awk -F: '{print $NF}' | xargs)
            echo "$gpu_name||$used_mem_mb/$total_mem_mb MB"
        done
    else
        # If no rocm-smi, just output the names
        for ((gpu=0; gpu<amd_count; gpu++)); do
            gpu_name="${amd_names[$gpu]:-AMD GPU $gpu}"
            echo "$gpu_name||Memory info unavailable"
        done
    fi
fi

# Process NVIDIA GPUs if found
if [ "$nvidia_count" -gt 0 ]; then
    if $has_nvidia_smi; then
        # Get memory usage for all NVIDIA GPUs
        nvidia_index=0
        nvidia-smi --query-gpu=index,memory.used,memory.total --format=csv,noheader,nounits | while read -r line; do
            index=$(echo "$line" | awk -F ', ' '{print $1}')
            used=$(echo "$line" | awk -F ', ' '{print $2}')
            total=$(echo "$line" | awk -F ', ' '{print $3}')
            
            # Output format: GPU_NAME||VRAM_INFO
            gpu_name="${nvidia_names[$nvidia_index]:-NVIDIA GPU $index}"
            echo "$gpu_name||$used/$total MB"
            
            nvidia_index=$((nvidia_index + 1))
        done
    else
        # If no nvidia-smi, just output the model names if available
        for ((gpu=0; gpu<nvidia_count; gpu++)); do
            gpu_name="${nvidia_names[$gpu]:-NVIDIA GPU $gpu}"
            echo "$gpu_name||Memory info unavailable"
        done
    fi
fi